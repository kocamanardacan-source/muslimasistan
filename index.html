<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Muslim Asistan</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <main class="container">
    <header class="top">
      <div class="brand">
        <h1>Muslim Asistan</h1>
        <p>Güncel vakitler ve ezan hatırlatıcı</p>
      </div>
      <div class="clock" id="liveClock">--:--:--</div>
    </header>

    <section class="controls">
      <button id="geoBtn" class="geoBtn">Konumumu Kullan ve Vakitleri Göster</button>
    </section>

    <section class="vakitler">
      <h2>Namaz Vakitleri</h2>
      <div id="timings" class="timings"></div>
    </section>

    <section class="countdown">
      <h3>Bir sonraki vakte kalan süre</h3>
      <div id="countdown">--:--:--</div>
      <div id="nextPrayer">--</div>
    </section>

    <footer>
      <small>Muslim Asistan — Yerel saat ve AlAdhan API ile çalışır.</small>
    </footer>
  </main>

  <!-- Ezan sesi (opsiyonel) -->
  <audio id="azanAudio" src="azan.mp3" preload="auto"></audio>

  <!-- JS Kodları Tek Dosya -->
  <script>
  const liveClockEl = document.getElementById('liveClock');
  const geoBtn = document.getElementById('geoBtn');
  const timingsEl = document.getElementById('timings');
  const countdownEl = document.getElementById('countdown');
  const nextPrayerEl = document.getElementById('nextPrayer');
  const azanAudio = document.getElementById('azanAudio');

  let currentTimings = null;
  let countdownInterval = null;
  let lastAnnounced = null;

  // Canlı saat
  function updateLiveClock() {
    const now = new Date();
    liveClockEl.textContent = now.toLocaleTimeString();
  }
  setInterval(updateLiveClock, 1000);
  updateLiveClock();

  // Bildirim izni
  async function ensureNotificationPermission(){
    if(!('Notification' in window)) return false;
    if(Notification.permission === 'granted') return true;
    const perm = await Notification.requestPermission();
    return perm === 'granted';
  }

  // API ile vakitleri al
  async function fetchTimingsByCoords(lat, lon){
    try{
      const timestamp = Math.floor(Date.now()/1000);
      const method = 2; // Diyanet
      const res = await fetch(`https://api.aladhan.com/v1/timings/${timestamp}?latitude=${lat}&longitude=${lon}&method=${method}`);
      const data = await res.json();
      if(data.code===200) return data.data;
      else throw new Error('API hata');
    }catch(err){
      alert('Vakitler alınamadı.');
      console.error(err);
      return null;
    }
  }

  // Vakitleri göster
  function renderTimings(data){
    if(!data) return;
    currentTimings = data.timings;
    timingsEl.innerHTML = '';

    const order = ['Fajr','Sunrise','Dhuhr','Asr','Maghrib','Isha'];
    order.forEach(name=>{
      const card = document.createElement('div');
      card.className = 'card';
      card.id = `card-${name}`;
      card.innerHTML = `<div class="label">${name}</div><div class="time">${currentTimings[name]}</div>`;
      timingsEl.appendChild(card);
    });

    highlightCurrentPrayer();
  }

  // Gelecek namaz vakti
  function getNextPrayerInfo(){
    if(!currentTimings) return null;
    const order = ['Fajr','Sunrise','Dhuhr','Asr','Maghrib','Isha'];
    const now = new Date();
    for(let i=0;i<order.length;i++){
      const name = order[i];
      const [hh,mm] = currentTimings[name].split(':').map(Number);
      let dt = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm,0);
      if(dt.getTime() > now.getTime()) return {name,time:dt};
    }
    return null; // Gün sonu, istersen yarınki ilk vakti ekleyebilirsin
  }

  // Vakit vurgulama
  function highlightCurrentPrayer(){
    if(!currentTimings) return;
    const order = ['Fajr','Sunrise','Dhuhr','Asr','Maghrib','Isha'];
    const now = new Date();
    let current=null;
    for(let i=0;i<order.length;i++){
      const name = order[i];
      const [hh,mm] = currentTimings[name].split(':').map(Number);
      const dt = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm,0);
      if(now >= dt) current=name;
    }
    if(!current) current='Fajr';
    order.forEach(name=>{
      const el = document.getElementById(`card-${name}`);
      if(!el) return;
      if(name===current) el.classList.add('current'); else el.classList.remove('current');
    });
  }

  // Geri sayım
  function startCountdown(){
    if(countdownInterval) clearInterval(countdownInterval);
    countdownInterval = setInterval(()=>{
      if(!currentTimings) return;
      const next = getNextPrayerInfo();
      if(next){
        const diff = next.time.getTime() - Date.now();
        const totalSec = Math.floor(diff/1000);
        if(totalSec<=0){
          onPrayerTime(next.name);
          return;
        }
        const hh = String(Math.floor(totalSec/3600)).padStart(2,'0');
        const mm = String(Math.floor((totalSec%3600)/60)).padStart(2,'0');
        const ss = String(totalSec%60).padStart(2,'0');
        countdownEl.textContent = `${hh}:${mm}:${ss}`;
        nextPrayerEl.textContent = next.name;
      } else {
        countdownEl.textContent = 'Günün kalan vaktinde sonraki vakit yok';
        nextPrayerEl.textContent='--';
      }
    },1000);
  }

  // Vakit geldiğinde uyarı
  async function onPrayerTime(name){
    const todayKey = `${name}-${new Date().toDateString()}`;
    if(lastAnnounced===todayKey) return;
    lastAnnounced=todayKey;

    try{
      if(azanAudio && azanAudio.src) await azanAudio.play();
      else if('speechSynthesis' in window){
        const utter = new SpeechSynthesisUtterance(`${name} vakti girdi. Ezan vaktidir.`);
        window.speechSynthesis.speak(utter);
      }
    }catch(err){console.warn(err);}

    const granted = await ensureNotificationPermission();
    if(granted) new Notification('Namaz Vakti', {body:`${name} vakti girdi.`});

    highlightCurrentPrayer();
  }

  // Konum butonu
  geoBtn.addEventListener('click', ()=>{
    if(!navigator.geolocation){ alert('Tarayıcı konum desteği yok'); return; }
    navigator.geolocation.getCurrentPosition(async pos=>{
      const lat=pos.coords.latitude;
      const lon=pos.coords.longitude;
      const data = await fetchTimingsByCoords(lat, lon);
      if(data) {
        renderTimings(data);
        startCountdown();
      }
    }, err=>{
      alert('Konum alınamadı: '+err.message);
    });
  });

  console.log('Muslim Asistan hazır. Konum butonuna tıklayın.');
  </script>
</body>
</html>
